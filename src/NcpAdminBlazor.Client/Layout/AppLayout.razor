@using MudBlazor.Utilities
@using NcpAdminBlazor.Client.Pages.Authentication
@using NcpAdminBlazor.Client.Shared

@layout MainLayout
@inherits LayoutComponentBase
@implements IAsyncDisposable
@inject IJSRuntime JsRuntime

<MudLayout Class="flex">
    @if (!LayoutStore.IsContentFullscreen)
    {
        <MudAppBar Dense Elevation="0" Gutters="false"
                   Class="pl-2 pr-3 border-b border-(--mud-palette-lines-default)">
            <MudIconButton Class="p-2" Icon="@Icons.Material.Outlined.Menu" Color="Color.Inherit"
                           OnClick="@DrawerToggle"/>
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudBreadcrumbs Class="py-3 px-1" Items="_breadcrumbItems"></MudBreadcrumbs>
            </MudHidden>
            <MudSpacer/>
            <MudIconButton Class="p-2"
                           Icon="@(_isBrowserFullscreen ? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                           Color="Color.Inherit"
                           OnClick="@ToggleBrowserFullscreen"/>
            <MudIconButton Class="p-2" Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit"
                           OnClick="@DarkModeToggle"/>
            <CultureSelector/>
            <MudMenu Dense="true">
                <ActivatorContent>
                    <MudIconButton Class="p-2" Color="Color.Inherit" Icon="@Icons.Material.Outlined.Widgets"/>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Href="https://mudblazor.com/">MudBlazor</MudMenuItem>
                    <MudMenuItem Href="https://github.com/Garderoben/MudBlazor.Templates">Source Code</MudMenuItem>
                </ChildContent>
            </MudMenu>
            <MudMenu Class="ml-4">
                <ActivatorContent>
                    <MudAvatar Size="Size.Small"/>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Icon="@Icons.Material.Outlined.Person"
                                 Href="/personal/account">
                        Account
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.Logout"
                                 OnClick="@Logout">
                        Logout
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>
        <MudDrawer @bind-Open="_drawerOpen" Elevation="0" Class="border-r border-(--mud-palette-lines-default)">
            <MudDrawerHeader>
                <NavLink ActiveClass="d-flex align-center" href="/">
                    <MudIcon Icon="@CustomIcons.Logo" Size="Size.Large" Class="mr-3"/>
                    <MudText Typo="Typo.h5" Color="Color.Primary" Class="font-semibold">Ncp Admin</MudText>
                </NavLink>
            </MudDrawerHeader>
            <NavMenu/>
        </MudDrawer>
    }
    <MudMainContent Class="@MainContentClass()">
        <PageTabs/>
        <MudContainer MaxWidth="MaxWidth.False" Class="p-4 overflow-auto grow">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    [CascadingParameter] private RouteData? RouteData { get; set; }
    [Inject] ICookieAuthService CookieAuthService { get; set; } = null!;
    [Inject] NavigationManager NavigationManager { get; set; } = null!;
    [Inject] BreadcrumbService BreadcrumbService { get; set; } = null!;
    [Inject] LayoutStore LayoutStore { get; set; } = null!;
    private bool _drawerOpen = true;
    private bool _isBrowserFullscreen;
    private List<BreadcrumbItem> _breadcrumbItems = [];
    private DotNetObjectReference<AppLayout>? _dotNetRef;
    private IJSObjectReference? _jsModule;

    private string MainContentClass() =>
        new CssBuilder("flex flex-col overflow-hidden")
            .AddClass("p-0", when: LayoutStore.IsContentFullscreen)
            .Build();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        BreadcrumbService.OnBreadcrumbsChanged += UpdateBreadcrumbs;
        LayoutStore.OnContentFullscreenChanged += OnContentFullscreenChanged;
        _breadcrumbItems = BreadcrumbService.CurrentItems.ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import",
                "./js/AppLayout.js");
            await _jsModule.InvokeVoidAsync("registerFullscreenHandler", _dotNetRef);
        }
    }

    [JSInvokable]
    public void OnBrowserFullscreenChanged(bool isFullscreen)
    {
        _isBrowserFullscreen = isFullscreen;
        StateHasChanged();
    }

    private void UpdateBreadcrumbs(List<BreadcrumbItem> items)
    {
        _breadcrumbItems = items;
        StateHasChanged();
    }

    private void OnContentFullscreenChanged(bool isFullscreen)
    {
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        BreadcrumbService.OnBreadcrumbsChanged -= UpdateBreadcrumbs;
        LayoutStore.OnContentFullscreenChanged -= OnContentFullscreenChanged;
        _dotNetRef?.Dispose();
        if (_jsModule is not null)
        {
            await _jsModule.DisposeAsync();
        }
    }

    private async Task ToggleBrowserFullscreen()
    {
        if (_jsModule is null) return;

        if (_isBrowserFullscreen)
        {
            await _jsModule.InvokeVoidAsync("exitFullscreen");
        }
        else
        {
            await _jsModule.InvokeVoidAsync("enterFullscreen");
        }
        // 状态由 fullscreenchange 事件监听器自动更新
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void DarkModeToggle()
    {
        LayoutStore.IsDarkMode = !LayoutStore.IsDarkMode;
    }

    private string DarkLightModeButtonIcon => LayoutStore.IsDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    async Task Logout()
    {

        // 清除服务端 Cookie
        await CookieAuthService.ClearAuthCookieAsync();
        
        // 强制页面重新加载以应用 Cookie 清除
        NavigationManager.NavigateTo(Login.PageUri, forceLoad: true);
    }


}