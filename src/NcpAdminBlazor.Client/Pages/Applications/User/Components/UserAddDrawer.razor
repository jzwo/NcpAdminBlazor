@using NcpAdminBlazor.Client.Infrastructure.Http
@using NcpAdminBlazor.Client.Pages.Applications.User.Validators
@using CreateUserRequest = NcpAdminBlazor.Client.Models.NcpAdminBlazorApiServiceEndpointsUsersManagementCreateUserRequest
@inject ApiWrapper ApiWrapper

<AppFormDrawer @bind-Open="Open"
               @bind-Open:after="()=>OpenChanged.InvokeAsync(Open)"
               Title="新增用户"
               OnClose="@CloseDrawerAsync"
               OnPrimaryAction="@HandleSaveAsync"
               OnCancel="@CloseDrawerAsync"
               PrimaryActionLoading="_saving">
    <MudForm @ref="_form" Model="_model" Validation="_validator.ValidateValue"
             Spacing="3">
        <MudTextField Label="用户名"
                      @bind-Value="_model.Username"
                      Required="true"
                      For="@(() => _model.Username)"/>
        <MudTextField Label="密码"
                      @bind-Value="_model.Password"
                      Required="true"
                      For="@(() => _model.Password)"
                      InputType="InputType.Password"/>
        <MudTextField Label="邮箱"
                      @bind-Value="_model.Email"
                      For="@(() => _model.Email)"/>
        <MudTextField Label="手机号"
                      @bind-Value="_model.Phone"
                      For="@(() => _model.Phone)"
                      InputType="InputType.Telephone"/>
        <MudTextField Label="真实名称"
                      @bind-Value="_model.RealName"
                      Required="true"
                      For="@(() => _model.RealName)"/>
    </MudForm>
</AppFormDrawer>

@code {
    [Parameter] public EventCallback OnSaved { get; set; }

    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback<bool> OpenChanged { get; set; }

    bool _saving;
    MudForm? _form;
    CreateUserRequest _model = new() { Password = string.Empty };
    readonly UserAddModelValidator _validator = new();


    async Task HandleSaveAsync()
    {
        if (_saving)
        {
            return;
        }

        if (_form is not null)
        {
            await _form.Validate();
            if (!_form.IsValid)
            {
                return;
            }
        }

        _saving = true;
        StateHasChanged();
        try
        {
            var request = new CreateUserRequest
            {
                Username = _model.Username?.Trim(),
                Password = _model.Password?.Trim(),
                Email = _model.Email?.Trim(),
                Phone = _model.Phone?.Trim(),
                RealName = _model.RealName?.Trim()
            };

            var created = await ApiWrapper.HandleCallAsync(apiClient => apiClient.Api.Users.PostAsync(request));
            if (!created)
            {
                return;
            }

            await CloseDrawerAsync();
            ResetModel();
            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    async Task CloseDrawerAsync()
    {
        if (!Open)
        {
            return;
        }

        Open = false;
        await OpenChanged.InvokeAsync(Open);
    }

    void ResetModel()
    {
        _model = new CreateUserRequest
        {
            Password = string.Empty
        };
    }

}
