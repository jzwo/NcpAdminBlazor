@page "/system/roles"
@attribute [Authorize]
@using NcpAdminBlazor.Client.Infrastructure.Http
@using NcpAdminBlazor.Client.Pages.Applications.Role.Components
@using NcpAdminBlazor.Client.Pages.Applications.Role.Models
@using RoleListItemDto = NcpAdminBlazor.Client.Models.NcpAdminBlazorApiServiceApplicationQueriesRolesManagementRoleListItemDto

<PageTitle>角色管理</PageTitle>
<MudStack Spacing="3" Class="h-full">
    <ShouldDisplay Value="_searchOpen">
        <QueryForm OnSearch="@OnSearchAsync"
                   OnReset="@OnResetAsync"
                   Context="itemAttrs">
            <QueryFormItem Label="角色名称">
                <MudTextField @bind-Value="_filter.Name"
                              Clearable="true"
                              Placeholder="请输入角色名称"
                              @attributes="itemAttrs"/>
            </QueryFormItem>
        </QueryForm>
    </ShouldDisplay>

    <AppDataGrid @ref="_dataGrid"
                 T="RoleListItemDto"
                 Title="角色列表"
                 AddButtonText="新增角色"
                 ServerData="ServerReload"
                 ActionColumnTitle="操作"
                 OnAdd="@OpenCreateDrawerAsync"
                 @bind-SearchOpen="_searchOpen">
        <ChildContent>
            <PropertyColumn Property="x => x.Name" Title="角色名称"/>
            <PropertyColumn Property="x => x.Description" Title="角色描述"/>
            <TemplateColumn Title="状态">
                <CellTemplate>
                    <MudChip T="string" Color="@(context.Item.IsDisabled is false ? Color.Success : Color.Default)"
                             Size="Size.Small" Variant="Variant.Filled">
                        @(context.Item.IsDisabled is false ? "启用" : "禁用")
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="创建时间">
                <CellTemplate>
                    @(context.Item.CreatedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? string.Empty)
                </CellTemplate>
            </TemplateColumn>
        </ChildContent>
        <EditActionTemplate Context="row">
            <MudMenu Icon="@Icons.Material.Filled.Edit" Dense Size="Size.Small" Color="@Color.Primary">
                <MudMenuItem Label="编辑" OnClick="@(() => OnEditRole(row))"/>
                <MudMenuItem Label="设置权限" OnClick="@(() => OnSetPermissions(row))"/>
            </MudMenu>
        </EditActionTemplate>
    </AppDataGrid>

    <RoleEditDrawer
        @bind-Open="_editDrawerOpen"
        EditingItem="_editingItem"
        OnSaved="HandleRoleUpdatedAsync"/>
    <RoleAddDrawer
        @bind-Open="_addDrawerOpen"
        OnSaved="HandleRoleCreatedAsync"/>
    <RolePermissionsDrawer
        @bind-Open="_permissionsDrawerOpen"
        EditingItem="_editingItem"
        OnSaved="HandlePermissionsUpdatedAsync"/>
</MudStack>

@code {

    [Inject] ApiWrapper ApiWrapper { get; set; } = null!;

    AppDataGrid<RoleListItemDto> _dataGrid = null!;
    readonly RoleSearchFilter _filter = new();

    bool _searchOpen = true;
    bool _editDrawerOpen;
    bool _addDrawerOpen;
    bool _permissionsDrawerOpen;
    RoleListItemDto? _editingItem;

    private async Task<GridData<RoleListItemDto>> ServerReload(GridState<RoleListItemDto> state)
    {
        var pageSize = state.PageSize > 0 ? state.PageSize : 10;
        var data = new GridData<RoleListItemDto>
        {
            Items = [],
            TotalItems = 0
        };

        await ApiWrapper.HandleCallAsync(
            apiClient => apiClient.Api.Roles.GetAsync(configure =>
            {
                configure.QueryParameters.Name = _filter.Name;
                configure.QueryParameters.PageIndex = state.Page + 1;
                configure.QueryParameters.PageSize = pageSize;
                configure.QueryParameters.CountTotal = true;
            }),
            result =>
            {
                if (result is not { Data: not null })
                {
                    return;
                }

                data.Items = result.Data.Items ?? [];
                data.TotalItems = result.Data.Total ?? 0;
            });

        return data;
    }

    private Task OnResetAsync()
    {
        _filter.Name = null;
        return Task.CompletedTask;
    }

    private Task OnSearchAsync()
    {
        return _dataGrid.ReloadServerData();
    }

    private void OnEditRole(RoleListItemDto item)
    {
        _editDrawerOpen = true;
        _editingItem = item;
    }

    private void OnSetPermissions(RoleListItemDto item)
    {
        _permissionsDrawerOpen = true;
        _editingItem = item;
    }

    private Task OpenCreateDrawerAsync()
    {
        _addDrawerOpen = true;
        return Task.CompletedTask;
    }

    private Task HandleRoleCreatedAsync()
    {
        return _dataGrid.ReloadServerData();
    }

    private Task HandleRoleUpdatedAsync(string? _)
    {
        return _dataGrid.ReloadServerData();
    }

    private Task HandlePermissionsUpdatedAsync()
    {
        return Task.CompletedTask;
    }

}
