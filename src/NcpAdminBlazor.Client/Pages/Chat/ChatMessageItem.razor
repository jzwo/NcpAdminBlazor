@using Microsoft.Extensions.AI
@using MudX

<MudXChat ChatPosition="@ChatPosition" Color="@BubbleColor" Variant="Variant.Filled" Elevation="0">
    <MudAvatar Size="Size.Medium" Color="@AvatarColor" Variant="Variant.Filled">@AvatarText</MudAvatar>
    <MudXChatHeader Name="@DisplayName" Time="@TimeText"/>
    <MudXChatBubble Class="max-w-2xl">
        @if (IsUser)
        {
            <MudText Typo="Typo.body1" Class="whitespace-pre-wrap wrap-break-word">@MessageText</MudText>
        }
        else
        {
            <MudMarkdown Value="@MessageText"/>
        }
    </MudXChatBubble>
</MudXChat>

@code {
    [Parameter] public ChatHistoryMessage Message { get; set; } = null!;

    private bool IsUser => Message.Message.Role == ChatRole.User;
    private string TimeText => Message.CreatedAt.ToLocalTime().ToString("HH:mm");
    private string DisplayName => IsUser ? "You" : "AI Assistant";
    private string AvatarText => IsUser ? "U" : "AI";
    private MudX.ChatBubblePosition ChatPosition => IsUser ? MudX.ChatBubblePosition.End : MudX.ChatBubblePosition.Start;
    private Color AvatarColor => IsUser ? Color.Primary : Color.Default;
    private Color BubbleColor => IsUser ? Color.Primary : Color.Default;

    private string MessageText
    {
        get
        {
            var chatMessage = Message.Message;

            if (chatMessage.Contents.Count > 0)
            {
                var text = string.Concat(chatMessage.Contents.OfType<TextContent>().Select(x => x.Text));
                if (!string.IsNullOrWhiteSpace(text))
                    return text;
            }

            return chatMessage.Text;
        }
    }

}
