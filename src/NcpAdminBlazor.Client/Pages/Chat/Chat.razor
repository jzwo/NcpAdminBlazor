@page "/chat"
@using Microsoft.Extensions.AI
@using NcpAdminBlazor.Client.HttpClientServices
@implements IDisposable

<PageTitle>AI Chat</PageTitle>

<MudPaper Outlined Class="h-full flex flex-col overflow-hidden">
    <MudToolBar Dense="true">
        <MudText Typo="Typo.h6">AI Assistant</MudText>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="@ResetConversationAsync"/>
    </MudToolBar>

    <ChatMessageList Messages="_messages" InProgressMessage="_currentResponseMessage">
        <NoMessagesContent>
            <MudIcon Icon="@Icons.Material.Outlined.ChatBubbleOutline" Size="Size.Large"/>
            <MudText Typo="Typo.h6">No messages yet. Start a conversation!</MudText>
        </NoMessagesContent>
    </ChatMessageList>

    <ChatInput OnSendMessage="HandleUserMessage"/>
</MudPaper>

@code {
    [Inject] private AiChatService AiChatService { get; set; } = null!;
    private readonly List<ChatMessage> _messages = [];
    private CancellationTokenSource? _currentResponseCancellation;
    private ChatMessage? _currentResponseMessage;

    private async Task HandleUserMessage(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();

        // Add user message
        _messages.Add(userMessage);
        var responseText = new TextContent("");
        _currentResponseMessage = new ChatMessage(ChatRole.Assistant, [responseText]);
        StateHasChanged();
        _currentResponseCancellation = new CancellationTokenSource();
        try
        {
            // Prepare assistant message container
            await foreach (var update in AiChatService.SendMessageStreamAsync(userMessage.Text, _currentResponseCancellation.Token))
            {
                _messages.AddMessages(update, filter: c => c is not TextContent);

                if (string.IsNullOrEmpty(update.Text))
                    continue;
                responseText.Text += update.Text;
                ChatMessageItem.NotifyChanged(_currentResponseMessage);

                await InvokeAsync(StateHasChanged);
            }

            _messages.Add(_currentResponseMessage!);
            _currentResponseMessage = null;
        }
        catch (Exception ex)
        {
            _currentResponseMessage = null;
            _messages.Add(new ChatMessage(ChatRole.System, $"Error: {ex.Message}"));
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void CancelAnyCurrentResponse()
    {
        // If a response was cancelled while streaming, include it in the conversation so it's not lost
        if (_currentResponseMessage is not null)
        {
        }

        _currentResponseCancellation?.Cancel();
        _currentResponseMessage = null;
    }

    private Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        _messages.Clear();
        return Task.CompletedTask;
    }


    public void Dispose()
        => _currentResponseCancellation?.Cancel();

}
